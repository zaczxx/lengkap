<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GOGO Short Drama - DarkAaa Pro</title>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #050505; color: #fff; margin: 0; padding: 0; }
    header { background: #111; padding: 20px; text-align: center; border-bottom: 2px solid #e91e63; box-shadow: 0 0 15px #e91e6355; }
    h1 { margin: 0; font-size: 1.5em; color: #e91e63; letter-spacing: 2px; }
    .tabs { display: flex; justify-content: center; gap: 8px; padding: 15px; overflow-x: auto; }
    .tab { background: #1a1a1a; padding: 8px 16px; border-radius: 20px; cursor: pointer; border: 1px solid #333; font-size: 0.9em; white-space: nowrap; }
    .tab.active { background: #e91e63; border-color: #f06292; font-weight: bold; }
    #search { width: 90%; max-width: 500px; padding: 12px 20px; margin: 10px auto; display: block; border-radius: 25px; border: 1px solid #333; background: #111; color: #fff; outline: none; }
    #search:focus { border-color: #e91e63; }
    #content { padding: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
    .card { background: #111; border-radius: 12px; overflow: hidden; cursor: pointer; border: 1px solid #222; transition: 0.3s; position: relative; }
    .card:hover { transform: translateY(-5px); border-color: #e91e63; }
    .card img { width: 100%; height: 220px; object-fit: cover; background: #1a1a1a; }
    .card-info { padding: 10px; background: linear-gradient(transparent, #000); position: absolute; bottom: 0; width: 100%; box-sizing: border-box; }
    .card p { margin: 0; font-size: 0.85em; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    #detail { display: none; padding: 20px; background: #000; min-height: 100vh; animation: fadeIn 0.3s; }
    #player-wrap { width: 100%; max-width: 800px; margin: 0 auto; background: #000; border: 1px solid #333; }
    video { width: 100%; aspect-ratio: 16/9; }
    #episodes { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 8px; margin-top: 20px; }
    .ep-btn { background: #1a1a1a; padding: 10px; border-radius: 6px; text-align: center; cursor: pointer; border: 1px solid #333; font-size: 0.8em; }
    .ep-btn.active { background: #e91e63; border-color: #e91e63; }
    #back { background: #e91e63; color: #fff; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-bottom: 15px; font-weight: bold; }
    #loading { text-align: center; padding: 40px; display: none; color: #e91e63; font-weight: bold; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @media (max-width: 600px) { #content { grid-template-columns: repeat(2, 1fr); } }
  </style>
</head>
<body>

<header><h1>GOGO SHORT DRAMA</h1></header>

<div class="tabs">
  <div class="tab active" data-source="melolo">Melolo</div>
  <div class="tab" data-source="dramabox">DramaBox</div>
  <div class="tab" data-source="freereels">FreeReels</div>
  <div class="tab" data-source="reelshort">Reelshort</div>
</div>

<input type="text" id="search" placeholder="Cari drama kesukaan lo bre..." />
<div id="loading">EXECUTING BYPASS...</div>
<div id="content"></div>

<div id="detail">
  <button id="back">‚Üê KEMBALI</button>
  <div id="player-wrap">
    <video id="player" controls poster="https://via.placeholder.com/800x450?text=Pilih+Episode"></video>
  </div>
  <h2 id="det-title" style="margin-top:15px; color:#e91e63;"></h2>
  <p id="det-desc" style="color:#aaa; font-size:0.9em; line-height:1.5;"></p>
  <h3 style="border-left: 4px solid #e91e63; padding-left: 10px;">Daftar Episode</h3>
  <div id="episodes"></div>
</div>

<script>
  const PROXY = "https://api.tatsumi-crew.net/proxy.php?url=";
  const BASE_API = "https://api.sonzaix.indevs.in";
  let currentSource = 'melolo';
  let activeDramaId = '';

  const content = document.getElementById('content');
  const loading = document.getElementById('loading');
  const detail = document.getElementById('detail');
  const player = document.getElementById('player');

  // Logic Tab
  document.querySelectorAll('.tab').forEach(t => {
    t.onclick = () => {
      document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
      t.classList.add('active');
      currentSource = t.dataset.source;
      fetchData(`/${currentSource}/populer?page=1`);
    };
  });

  // Search
  document.getElementById('search').oninput = debounce(function(e) {
    const q = e.target.value;
    if(q.length > 2) {
      let path = `/${currentSource}/search?q=${encodeURIComponent(q)}&page=1`;
      if(currentSource === 'reelshort') path = `/reelshort/search?query=${encodeURIComponent(q)}`;
      fetchData(path);
    } else {
      fetchData(`/${currentSource}/populer?page=1`);
    }
  }, 600);

  async function fetchData(path) {
    loading.style.display = 'block';
    content.innerHTML = '';
    try {
      const res = await fetch(PROXY + encodeURIComponent(BASE_API + path));
      const json = await res.json();
      
      // FIX: Loop semua item, bukan cuma satu
      let list = [];
      if (Array.isArray(json.data)) list = json.data;
      else if (json.data && json.data.books) list = json.data.books;
      
      if(list.length === 0) content.innerHTML = '<p style="grid-column:1/-1;text-align:center;">Data Kosong Bre.</p>';

      list.forEach(item => {
        // Normalisasi data dari berbagai API
        const d = item.books ? item.books[0] : item;
        const id = d.drama_id || d.bookId || d.id;
        if(!id) return;

        // FIX: Image Fallback untuk Melolo & Lainnya
        const thumb = d.horizontal_url || d.thumb_url || d.cover || d.cover_url || 'https://via.placeholder.com/150x220?text=No+Poster';

        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <img src="${thumb}" onerror="this.src='https://via.placeholder.com/150x220?text=Error+Img'">
          <div class="card-info"><p>${d.drama_name || d.title || 'Judul Ghoib'}</p></div>
        `;
        card.onclick = () => showDetail(id, d.drama_name || d.title);
        content.appendChild(card);
      });
    } catch (e) {
      content.innerHTML = `<p style="color:red">Error: ${e.message}</p>`;
    }
    loading.style.display = 'none';
  }

  async function showDetail(id, title) {
    activeDramaId = id;
    loading.style.display = 'block';
    try {
      let path = `/${currentSource}/detail/${id}`;
      if(currentSource === 'freereels') path = `/freereels/detail?dramaId=${id}`;
      if(currentSource === 'reelshort') path = `/reelshort/detail?bookId=${id}`;

      const res = await fetch(PROXY + encodeURIComponent(BASE_API + path));
      const json = await res.json();
      const d = json.data?.books ? json.data.books[0] : (json.data || json);

      document.getElementById('det-title').textContent = title;
      document.getElementById('det-desc').textContent = d.description || d.synopsis || 'Gak ada deskripsi.';
      
      const epDiv = document.getElementById('episodes');
      epDiv.innerHTML = '';

      // Render Episode Buttons
      if (currentSource === 'melolo' && json.video_list) {
        json.video_list.forEach(v => createEp(v.episode, v.video_id));
      } else {
        const total = d.episode_count || (d.chapterList ? d.chapterList.length : 0);
        for(let i=1; i<=total; i++) createEp(i, i-1);
      }

      content.style.display = 'none';
      detail.style.display = 'block';
      window.scrollTo(0,0);
    } catch (e) { alert("Detail tewas: " + e.message); }
    loading.style.display = 'none';
  }

  function createEp(label, val) {
    const b = document.createElement('div');
    b.className = 'ep-btn';
    b.textContent = `EP ${label}`;
    b.onclick = () => {
      document.querySelectorAll('.ep-btn').forEach(x => x.classList.remove('active'));
      b.classList.add('active');
      playStream(val);
    };
    document.getElementById('episodes').appendChild(b);
  }

  async function playStream(ep) {
    try {
      let path = `/${currentSource}/stream/${ep}`;
      if(currentSource === 'dramabox') path = `/dramabox/stream?dramaId=${activeDramaId}&episodeIndex=${ep}`;
      if(currentSource === 'freereels') path = `/freereels/stream?dramaId=${activeDramaId}&episode=${parseInt(ep)+1}`;
      if(currentSource === 'reelshort') path = `/reelshort/stream?bookId=${activeDramaId}&episodeNumber=${parseInt(ep)+1}`;

      const res = await fetch(PROXY + encodeURIComponent(BASE_API + path));
      const json = await res.json();
      
      // FIX: Melolo & Global Video URL mapping
      const url = json.data?.qualities?.[0]?.videoPath || json.data?.video_url || json.video_url || json.url;

      if(url) {
        player.src = url;
        player.play();
        window.scrollTo(0,0);
      } else {
        alert("Link video tewas bre!");
      }
    } catch (e) { alert("Stream Error: " + e.message); }
  }

  document.getElementById('back').onclick = () => {
    detail.style.display = 'none';
    content.style.display = 'grid';
    player.pause();
    player.src = '';
  };

  function debounce(f, w) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => f(...a), w); }; }
  
  // Start
  fetchData('/melolo/populer?page=1');
</script>
</body>
</html>
